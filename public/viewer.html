<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualiseur KML Avancé</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* CSS avec la largeur du panneau augmentée */
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif; overflow: hidden;
    }
    #app-container { 
      position: relative;
      display: flex; height: 100%; width: 100%; 
    }
    #sidebar {
      width: 350px; /* MODIFIÉ */
      background: #f4f4f4; border-right: 1px solid #ccc;
      display: flex; flex-direction: column;
      transition: margin-left 0.3s ease-in-out; z-index: 1000;
    }
    #sidebar.hidden { margin-left: -350px; } /* MODIFIÉ */
    #title-section { padding: 10px; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    #title-section h3 { margin: 0; font-size: 18px; }
    #title-section a { color: #007bff; text-decoration: none; font-size: 14px; }
    #title-section a:hover { text-decoration: underline; }
    #kml-list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }
    #kmlTree { list-style-type: none; padding: 0; margin: 0; }
    .kml-file-item { margin-bottom: 2px; }
    .kml-file-header {
      display: flex;
      align-items: center;
      padding: 4px;
      cursor: pointer;
    }
    .kml-file-header:hover { background-color: #e0e0e0; }
    .toggle-arrow {
      width: 16px; height: 16px; flex-shrink: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='currentColor' d='M6 4l4 4-4 4z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: center;
      transition: transform 0.2s ease-in-out;
    }
    .kml-file-item.expanded > .kml-file-header > .toggle-arrow { transform: rotate(90deg); }
    .kml-file-header input[type="checkbox"] { margin: 0 5px; }
    .placemarks-list {
      list-style-type: none; padding-left: 25px; display: none;
    }
    .kml-file-item.expanded > .placemarks-list { display: block; }
    .placemark-item {
      padding: 4px 0 4px 16px; cursor: pointer;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .placemark-item:hover { background-color: #e9e9e9; }
    #sidebar-toggle {
      position: absolute; top: 90px; left: 10px; z-index: 1001;
      background-color: #007bff; color: white; border: 1px solid #0056b3;
      border-radius: 5px; width: 35px; height: 35px; font-size: 20px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: left 0.3s ease-in-out, top 0.3s ease-in-out;
    }
    #sidebar:not(.hidden) + #sidebar-toggle { left: 360px; } /* MODIFIÉ */
    #map { flex-grow: 1; min-width: 0; z-index: 1; background-color: #f0f0f0; }
  </style>
</head>
<body>

<div id="app-container">
  <div id="sidebar" class="hidden">
    <div id="title-section"><h3>Fichiers KML</h3><a href="/">Retour à l'accueil</a></div>
    <div id="kml-list-container">
      <ul id="kmlTree"></ul>
    </div>
  </div>
  <button type="button" id="sidebar-toggle" title="Masquer/Afficher la barre latérale"><span>&#9776;</span></button>
  <div id="map"></div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
<script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.4.0/Leaflet.GoogleMutant.js"></script>
<!-- N'oubliez pas de mettre votre clé API sécurisée ici -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBs4IgA9Qe_yqk7FTKPTW0HYwCTQf4dNlg"></script>

<script>
  const map = L.map('map', { maxZoom: 22 }).setView([36, 3], 6);

  L.gridLayer.googleMutant({ type: 'satellite', maxZoom: 21 }).addTo(map);

  const kmlLayers = {};

  function loadAndDisplayKml(filename, fileLi, placemarksUl, checkbox) {
    if (kmlLayers[filename] && kmlLayers[filename].loaded) return;

    const kmlUrl = `/kml/${filename}`;
    const featureGroup = L.featureGroup();
    kmlLayers[filename] = { mainLayer: featureGroup, features: {}, loaded: false };

    placemarksUl.innerHTML = '<li>Chargement...</li>';
    const omniLayer = omnivore.kml(kmlUrl);
    
    omniLayer.on('ready', function() {
      placemarksUl.innerHTML = '';
      let featureCount = 0;

      this.eachLayer(function(layer) {
        featureCount++;
        const featureName = layer.feature.properties.name || `Parcelle Sans Nom ${featureCount}`;
        
        if (layer.setStyle) layer.setStyle({ color: '#FF0000', weight: 1.5, opacity: 0.8, fillColor: 'transparent', fillOpacity: 0 });
        const popupContent = `<b>${featureName}</b><br>${layer.feature.properties.description || ''}`;
        layer.bindPopup(popupContent);

        featureGroup.addLayer(layer);
        kmlLayers[filename].features[featureName] = layer;

        const placemarkLi = document.createElement('li');
        placemarkLi.className = 'placemark-item';
        placemarkLi.textContent = featureName;
        placemarksUl.appendChild(placemarkLi);

        placemarkLi.addEventListener('click', () => {
          if (checkbox.checked) {
            layer.setStyle({ color: '#00FFFF', weight: 3 });
            setTimeout(() => layer.setStyle({ color: '#FF0000', weight: 1.5 }), 30000);
          }
        });
      });
      
      kmlLayers[filename].loaded = true;
      
      if (checkbox.checked) {
        featureGroup.addTo(map);
        map.fitBounds(featureGroup.getBounds(), { padding: [50, 50] });
      }
    }).on('error', () => {
      placemarksUl.innerHTML = '<li>Erreur de chargement.</li>';
    });
  }

  function toggleKmlVisibility(filename, isVisible) {
    if (!kmlLayers[filename] || !kmlLayers[filename].loaded) return;
    if (isVisible) {
      kmlLayers[filename].mainLayer.addTo(map);
      map.fitBounds(kmlLayers[filename].mainLayer.getBounds(), { padding: [50, 50] });
    } else {
      map.removeLayer(kmlLayers[filename].mainLayer);
    }
  }

  fetch('/liste-kml').then(res => res.json()).then(files => {
    const kmlTree = document.getElementById('kmlTree');
    files.forEach(file => {
      const fileLi = document.createElement('li');
      fileLi.className = 'kml-file-item';

      const headerDiv = document.createElement('div');
      headerDiv.className = 'kml-file-header';
      headerDiv.innerHTML = `
        <span class="toggle-arrow"></span>
        <input type="checkbox" value="${file}">
        <span class="file-name">${file}</span>
      `;
      
      const placemarksUl = document.createElement('ul');
      placemarksUl.className = 'placemarks-list';

      fileLi.appendChild(headerDiv);
      fileLi.appendChild(placemarksUl);
      kmlTree.appendChild(fileLi);

      const checkbox = headerDiv.querySelector('input[type="checkbox"]');
      
      headerDiv.addEventListener('click', (e) => {
        if (e.target.type !== 'checkbox') {
          fileLi.classList.toggle('expanded');
          if (fileLi.classList.contains('expanded') && !kmlLayers[file]) {
            loadAndDisplayKml(file, fileLi, placemarksUl, checkbox);
          }
        }
      });
      
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          if (kmlLayers[file] && kmlLayers[file].loaded) {
            toggleKmlVisibility(file, true);
          } else {
            loadAndDisplayKml(file, fileLi, placemarksUl, checkbox);
          }
        } else {
          toggleKmlVisibility(file, false);
        }
      });
    });
  });

  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebar-toggle');
  
  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('hidden');
    setTimeout(() => { map.invalidateSize(); }, 300);
  });
  
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => { map.invalidateSize(); }, 100);
  });

  window.addEventListener('resize', () => { map.invalidateSize(); });
</script>

</body>
</html>```